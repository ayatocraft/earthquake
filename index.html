<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°éœ‡ãƒ»æ´¥æ³¢ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <style>
        /* åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (å¤‰æ›´ãªã—) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f0f2f5;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: #333;
            color: white;
            height: 50px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        header h1 {
            font-size: 1.2em;
            margin: 0;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #map {
            flex: 1;
            background-color: #ddd;
        }

        #sidebar {
            width: 350px;
            background: #ffffff;
            padding: 15px;
            overflow-y: auto;
            border-left: 1px solid #ccc;
            box-shadow: -2px 0 5px rgba(0,0,0,0.05);
        }
        
        #sidebar h2, #sidebar h3, #sidebar h4 {
            color: #111;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .info-section {
            margin-bottom: 20px;
        }
        .info-section ul {
            padding-left: 20px;
            margin: 0;
        }
        .info-section li {
            margin-bottom: 5px;
            list-style-type: none;
            padding-left: 5px;
        }
        .info-section li::before {
            content: 'ãƒ»';
            margin-right: 5px;
        }

        .user-info {
            display: none;
        }

        /* --- APIæ¥ç¶šçŠ¶æ³ã‚¢ã‚¤ã‚³ãƒ³ --- */
        #api-status {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        .status-connecting { background-color: #ffc107; }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }

        /* èª¤å ±ãƒ»å–ã‚Šæ¶ˆã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¬„ */
        #status-message {
            padding: 10px;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
            font-weight: bold;
        }
        #status-message.training {
             background-color: #fff3cd;
             color: #856404;
             border-color: #ffeeba;
        }

        /* --- éœ‡åº¦ãƒ»æ´¥æ³¢ã®è‰²ã®å‡¡ä¾‹ --- */
        .intensity-1 { color: blue; }
        .intensity-2 { color: green; }
        .intensity-3 { color: #E6A200; }
        .intensity-4 { color: orange; }
        .intensity-5-weak { color: red; font-weight: bold; }
        .intensity-5-strong { color: red; font-weight: bold; }
        .intensity-6-weak { color: darkmagenta; font-weight: bold; }
        .intensity-6-strong { color: darkmagenta; font-weight: bold; }
        .intensity-7 { color: purple; font-weight: bold; }

        .tsunami-safe { border-left: 5px solid green; padding-left: 5px; }
        .tsunami-advisory { border-left: 5px solid yellow; padding-left: 5px; }
        .tsunami-warning { border-left: 5px solid red; padding-left: 5px; font-weight: bold; }
        .tsunami-major { border-left: 5px solid darkmagenta; padding-left: 5px; font-weight: bold; }

        /* éœ‡æºåœ°ãƒãƒ¼ã‚«ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .hypocenter-icon {
            font-size: 24px;
            text-align: center;
            line-height: 24px;
        }
    </style>
</head>
<body>

    <header>
        <h1>åœ°éœ‡ãƒ»æ´¥æ³¢ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</h1>
        <div id="api-status" class="status-connecting" title="APIæ¥ç¶šçŠ¶æ³"></div>
    </header>

    <div class="container">
        <div id="map"></div>

        <aside id="sidebar">
            <h2>æƒ…å ±ãƒ‘ãƒãƒ«</h2>
            
            <div id="status-message"></div>

            <div id="earthquake-info" class="info-section" style="display: none;">
                <h3>æœ€æ–°ã®åœ°éœ‡æƒ…å ±</h3>
                <div><strong>æœ€å¤§éœ‡åº¦:</strong> <span id="max-intensity">---</span></div>
                <div><strong>ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰:</strong> <span id="magnitude">---</span></div>
                <div><strong>éœ‡æºåœ°:</strong> <span id="hypocenter">---</span></div>
                <div><strong>ç™ºç”Ÿæ™‚åˆ»:</strong> <span id="earthquake-time">---</span></div>
                
                <h4>å„åœ°ã®éœ‡åº¦ (å¸‚åŒºç”ºæ‘)</h4>
                <ul id="intensity-details"></ul>
                
                <h4 style="margin-top: 20px;">æ´¥æ³¢æƒ…å ±</h4>
                <div id="tsunami-warning">---</div>
                <ul id="tsunami-details"></ul>
            </div>

            <div id="recent-info" class="info-section">
                <h3>å¾…æ©Ÿä¸­</h3>
                <p>åœ°éœ‡ãƒ»æ´¥æ³¢æƒ…å ±ã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™...</p>
                <p>ï¼ˆç›´è¿‘ã®åœ°éœ‡å±¥æ­´ã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</p>
                <ul id="recent-list"></ul>
            </div>

            <div class="user-info"></div>
        </aside>
    </div>

    <audio id="alert-sound" src="alert.mp3" preload="auto"></audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
     
    <script>
        document.addEventListener('DOMContentLoaded', async function() { // â˜… asyncã«å¤‰æ›´

            // --- 1. åœ°å›³ã®åˆæœŸåŒ– ---
            const map = L.map('map').setView([36.2048, 138.2529], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const earthquakeLayer = L.layerGroup().addTo(map);

            // --- 2. DOMè¦ç´ ã®å–å¾— ---
            const apiStatusIcon = document.getElementById('api-status');
            const alertSound = document.getElementById('alert-sound');
            const earthquakeInfoPanel = document.getElementById('earthquake-info');
            const recentInfoPanel = document.getElementById('recent-info');
            
            const maxIntensityEl = document.getElementById('max-intensity');
            const magnitudeEl = document.getElementById('magnitude');
            const hypocenterEl = document.getElementById('hypocenter');
            const earthquakeTimeEl = document.getElementById('earthquake-time');
            const intensityDetailsEl = document.getElementById('intensity-details');
            const tsunamiWarningEl = document.getElementById('tsunami-warning');
            const tsunamiDetailsEl = document.getElementById('tsunami-details');
            const recentListEl = document.getElementById('recent-list');
            const statusMessageEl = document.getElementById('status-message');

            let resetTimer = null;

            // çŠ¶æ…‹ç®¡ç†
            let lastNotifiedInfo = {
                eewId: null,
                maxScale: 0,
                tsunamiGrade: 'Safe',
                isEEWActive: false
            };
            
            // â˜… æ–°è¦: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«ãªã£ãŸæ™‚åˆ»ã‚’è¨˜éŒ²
            let lastOfflineTime = null;


            // --- 3. WebSocket ã¸ã®æ¥ç¶š ---
            let ws = null;
            const wsUrl = 'wss://api.p2pquake.net/v2/ws';

            function connectWebSocket() {
                console.log('WebSocketã«æ¥ç¶šè©¦è¡Œä¸­...');
                updateApiStatus('connecting');
                
                ws = new WebSocket(wsUrl);

                // â˜… å¤‰æ›´: æ¥ç¶šæˆåŠŸæ™‚ï¼ˆã‚¹ãƒªãƒ¼ãƒ—å¾©å¸°æ™‚ï¼‰ã®å‡¦ç†
                ws.onopen = async function() {
                    console.log('WebSocketæ¥ç¶šæˆåŠŸï¼');
                    updateApiStatus('connected');
                    
                    // â˜… æ–°è¦: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã®åœ°éœ‡ãƒã‚§ãƒƒã‚¯ (Feature 2)
                    if (lastOfflineTime) {
                        console.log(`ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‹ã‚‰å¾©å¸°ã€‚(${lastOfflineTime.toLocaleString()} ä»¥é™ã‚’ãƒã‚§ãƒƒã‚¯)`);
                        try {
                            const historyUrl = 'https://api.p2pquake.net/v2/history?codes=551&limit=20';
                            const response = await fetch(historyUrl);
                            const data = await response.json();
                            
                            let offlineCount = 0;
                            if (data) {
                                data.forEach(quake => {
                                    if (new Date(quake.time) > lastOfflineTime) {
                                        offlineCount++;
                                    }
                                });
                            }
                            
                            if (offlineCount > 0) {
                                sendNotification(
                                    "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°",
                                    `ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã®é–“ã« ${offlineCount} ä»¶ã®åœ°éœ‡ãŒã‚ã‚Šã¾ã—ãŸã€‚`
                                );
                            }
                            
                        } catch (err) {
                            console.error('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¸­ã®åœ°éœ‡å±¥æ­´å–å¾—ã«å¤±æ•—:', err);
                        }
                        lastOfflineTime = null; // ãƒã‚§ãƒƒã‚¯å®Œäº†
                    }
                };

                // â˜… å¤‰æ›´: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆWebSocketã®ãƒ—ãƒƒã‚·ãƒ¥å—ä¿¡ï¼‰
                // (Feature 3: 10ç§’ãƒãƒ¼ãƒªãƒ³ã‚°ã‚ˆã‚Šé«˜é€Ÿãªãƒ—ãƒƒã‚·ãƒ¥å‹ã‚’æ¡ç”¨)
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.training) {
                        console.log('è¨“ç·´æƒ…å ±ã‚’å—ä¿¡:', data);
                        showStatusMessage('è¨“ç·´æƒ…å ±ã‚’å—ä¿¡ã—ã¾ã—ãŸã€‚', 'training');
                        return;
                    }
                    if (data.code === 9611) {
                        console.log('EEWå–ã‚Šæ¶ˆã—å ± å—ä¿¡');
                        showStatusMessage('ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã¯å–ã‚Šæ¶ˆã•ã‚Œã¾ã—ãŸã€‚', 'error');
                        lastNotifiedInfo.isEEWActive = false;
                        setResetTimer();
                        return;
                    }
                    if (data.code === 552 && data.cancelled) {
                         console.log('æ´¥æ³¢äºˆå ±è§£é™¤ å—ä¿¡');
                    } else {
                        hideStatusMessage();
                    }

                    console.log(`[${data.code}] ãƒ‡ãƒ¼ã‚¿å—ä¿¡:`, data);
                    let infoReceived = false;

                    if (data.code === 551) { // åœ°éœ‡æƒ…å ±
                        if (handleEarthquakeInfo(data)) infoReceived = true;
                    } else if (data.code === 552) { // æ´¥æ³¢äºˆå ±
                        if (handleTsunamiInfo(data)) infoReceived = true;
                    } else if (data.code === 556) { // EEW(è­¦å ±)
                        if (handleEEW(data)) infoReceived = true;
                    }
                    
                    if (infoReceived) {
                        setResetTimer();
                    }
                };

                // â˜… å¤‰æ›´: ã‚¹ãƒªãƒ¼ãƒ—å¾©å¸°æ™‚ã®å†æ¥ç¶šãƒˆãƒªã‚¬ãƒ¼ (Feature 1)
                ws.onclose = function() {
                    console.log('WebSocketæ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸã€‚5ç§’å¾Œã«å†æ¥ç¶šã—ã¾ã™ã€‚');
                    updateApiStatus('disconnected');
                    
                    // â˜… æ–°è¦: åˆ‡æ–­æ™‚åˆ»ã‚’è¨˜éŒ²
                    if (lastOfflineTime === null) {
                        lastOfflineTime = new Date();
                    }
                    
                    if (resetTimer) clearTimeout(resetTimer); 
                    setTimeout(connectWebSocket, 5000);
                };

                ws.onerror = function(error) {
                    console.error('WebSocketã‚¨ãƒ©ãƒ¼:', error);
                    updateApiStatus('disconnected');
                };
            }
            
            // 10åˆ†å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆå±¥æ­´è¡¨ç¤ºã«æˆ»ã™ï¼‰ã‚¿ã‚¤ãƒãƒ¼
            function setResetTimer() {
                if (resetTimer) {
                    clearTimeout(resetTimer);
                }
                resetTimer = setTimeout(() => {
                    console.log('10åˆ†é–“æƒ…å ±æ›´æ–°ãŒãªã‹ã£ãŸãŸã‚ã€å¹³å¸¸æ™‚ç”»é¢ã«æˆ»ã—ã¾ã™ã€‚');
                    fetchRecentEarthquakes(); // å±¥æ­´ä¸€è¦§ã«æˆ»ã™
                    earthquakeLayer.clearLayers(); 
                    lastNotifiedInfo = {
                        eewId: null, maxScale: 0, tsunamiGrade: 'Safe', isEEWActive: false
                    };
                    hideStatusMessage();
                }, 600000); // 10åˆ†
            }

            // èª¤å ±/ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            function showStatusMessage(message, type = 'error') {
                statusMessageEl.textContent = message;
                statusMessageEl.className = type;
                statusMessageEl.style.display = 'block';
            }
            function hideStatusMessage() {
                 statusMessageEl.style.display = 'none';
            }

            // --- 4. APIã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–¢æ•° ---
            function updateApiStatus(status) {
                apiStatusIcon.className = '';
                if (status === 'connecting') {
                    apiStatusIcon.classList.add('status-connecting');
                    apiStatusIcon.title = 'APIæ¥ç¶šä¸­...';
                } else if (status === 'connected') {
                    apiStatusIcon.classList.add('status-connected');
                    apiStatusIcon.title = 'APIæ¥ç¶šå®Œäº†';
                } else {
                    apiStatusIcon.classList.add('status-disconnected');
                    apiStatusIcon.title = 'APIåˆ‡æ–­ (5ç§’å¾Œã«å†æ¥ç¶š)';
                }
            }
            
            // --- 5. å¹³å¸¸æ™‚ã®æƒ…å ±å–å¾— (å±¥æ­´ä¸€è¦§) ---
            function fetchRecentEarthquakes() {
                const historyUrl = 'https://api.p2pquake.net/v2/history?codes=551&limit=5';
                fetch(historyUrl)
                    .then(response => response.json())
                    .then(data => {
                        recentListEl.innerHTML = '';
                        if (data && data.length > 0) {
                            data.forEach(quake => {
                                if (quake.earthquake) {
                                    const li = document.createElement('li');
                                    const time = new Date(quake.time).toLocaleString('ja-JP');
                                    const hypocenter = quake.earthquake.hypocenter.name;
                                    const maxScale = convertScale(quake.earthquake.maxScale);
                                    li.textContent = `${time} | ${hypocenter} | æœ€å¤§éœ‡åº¦ ${maxScale || 'ä¸æ˜'}`;
                                    recentListEl.appendChild(li);
                                }
                            });
                        }
                        earthquakeInfoPanel.style.display = 'none';
                        recentInfoPanel.style.display = 'block';
                    })
                    .catch(err => {
                        console.error('åœ°éœ‡å±¥æ­´ã®å–å¾—ã«å¤±æ•—:', err);
                        recentListEl.textContent = 'å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                    });
            }

            // --- 6. ãƒ‡ãƒ¼ã‚¿å‡¦ç†é–¢æ•° ---

            // [551] åœ°éœ‡æƒ…å ± (å¤‰æ›´ãªã—)
            function handleEarthquakeInfo(data) {
                console.log('åœ°éœ‡æƒ…å ±å‡¦ç†:', data);
                const eq = data.earthquake;

                if (!eq || !eq.time) {
                    console.warn('[551] å¿…é ˆãƒ‡ãƒ¼ã‚¿(eq or time)ãŒæ¬ è½ã€‚ã‚¹ã‚­ãƒƒãƒ—:', data);
                    return false;
                }

                const maxScale = eq.maxScale || 0;
                const magnitude = eq.hypocenter?.magnitude || 0;
                const hypoName = eq.hypocenter?.name || "";
                const hypoLat = eq.hypocenter?.latitude || 0;
                const points = data.points || [];

                if (maxScale <= 0 && magnitude <= 0 && hypoName === "" && hypoLat === 0 && points.length === 0) {
                    console.warn('[551] æ™‚é–“ä»¥å¤–ã®ä¸»è¦æƒ…å ±ãŒã™ã¹ã¦ä¸æ˜ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—:', data);
                    return false;
                }

                if (eq.maxScale >= 30 && !lastNotifiedInfo.isEEWActive) {
                    sendNotification(
                        `åœ°éœ‡æƒ…å ±ï¼ˆéœ‡åº¦${convertScale(eq.maxScale)}ï¼‰`,
                        `${eq.hypocenter.name}ã§åœ°éœ‡ç™ºç”Ÿã€‚æœ€å¤§éœ‡åº¦${convertScale(eq.maxScale)}ã€‚`
                    );
                }
                
                lastNotifiedInfo.isEEWActive = false;
                
                earthquakeInfoPanel.style.display = 'block';
                recentInfoPanel.style.display = 'none';
                
                maxIntensityEl.textContent = maxScale > 0 ? `${convertScale(maxScale)} ( ${convertScaleText(maxScale)} )` : 'æƒ…å ±ãªã—';
                magnitudeEl.textContent = eq.hypocenter.magnitude || '---';
                hypocenterEl.textContent = eq.hypocenter.name || '---';
                earthquakeTimeEl.textContent = new Date(eq.time).toLocaleString('ja-JP');

                intensityDetailsEl.innerHTML = '';
                if (data.points) {
                    data.points.sort((a, b) => b.scale - a.scale);
                    data.points.forEach(point => {
                        if (point.scale <= 0) return;
                        const li = document.createElement('li');
                        li.textContent = `[${convertScale(point.scale)}] ${point.addr}`;
                        li.className = getIntensityClass(point.scale);
                        intensityDetailsEl.appendChild(li);
                    });
                }
                
                earthquakeLayer.clearLayers();
                if (eq.hypocenter.latitude && eq.hypocenter.longitude) {
                    const lat = eq.hypocenter.latitude;
                    const lon = eq.hypocenter.longitude;
                    
                    L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'hypocenter-icon',
                            html: 'âŒ',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    }).addTo(earthquakeLayer)
                        .bindPopup(`éœ‡æºåœ°: ${eq.hypocenter.name}<br>M${eq.magnitude}<br>æ·±ã•: ${eq.hypocenter.depth}km`)
                        .openPopup();
                    
                    map.setView([lat, lon], 7);
                }
                
                return true;
            }

            // [552] æ´¥æ³¢äºˆå ± (å¤‰æ›´ãªã—)
            function handleTsunamiInfo(data) {
                console.log('æ´¥æ³¢æƒ…å ±å‡¦ç†:', data);

                earthquakeInfoPanel.style.display = 'block';
                recentInfoPanel.style.display = 'none';
                
                tsunamiWarningEl.innerHTML = '';
                tsunamiDetailsEl.innerHTML = '';
                
                let highestGrade = 'Safe';
                let notificationTitle = 'æ´¥æ³¢æƒ…å ±';
                let notificationBody = 'æ´¥æ³¢æƒ…å ±ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚';

                if (data.cancelled) {
                    tsunamiWarningEl.textContent = 'æ´¥æ³¢äºˆå ±ã¯è§£é™¤ã•ã‚Œã¾ã—ãŸã€‚';
                    tsunamiWarningEl.className = 'tsunami-safe';
                    highestGrade = 'Safe';
                    notificationBody = 'æ´¥æ³¢äºˆå ±ã¯è§£é™¤ã•ã‚Œã¾ã—ãŸã€‚';
                    if (resetTimer) clearTimeout(resetTimer);
                    fetchRecentEarthquakes();
                } else if (!data.areas || data.areas.length === 0) {
                    tsunamiWarningEl.textContent = 'æ´¥æ³¢ã®å¿ƒé…ãªã—';
                    tsunamiWarningEl.className = 'tsunami-safe';
                    highestGrade = 'Safe';
                    notificationBody = 'æ´¥æ³¢ã®å¿ƒé…ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                } else {
                    data.areas.forEach(area => {
                        const li = document.createElement('li');
                        li.textContent = `${area.name} - ${area.grade}`;
                        
                        if (area.grade === 'MajorWarning') {
                            li.className = 'tsunami-major';
                            highestGrade = 'MajorWarning';
                        } else if (area.grade === 'Warning') {
                            li.className = 'tsunami-warning';
                            if (highestGrade !== 'MajorWarning') highestGrade = 'Warning';
                        } else if (area.grade === 'Advisory') {
                            li.className = 'tsunami-advisory';
                            if (highestGrade === 'Safe') highestGrade = 'Advisory';
                        }
                        tsunamiDetailsEl.appendChild(li);
                    });

                    if (highestGrade === 'MajorWarning') {
                        tsunamiWarningEl.textContent = 'ã€å¤§æ´¥æ³¢è­¦å ±ã€‘';
                        tsunamiWarningEl.className = 'tsunami-major';
                        notificationTitle = 'ã€å¤§æ´¥æ³¢è­¦å ±ã€‘';
                        notificationBody = 'å¤§æ´¥æ³¢è­¦å ±ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸã€‚ç›´ã¡ã«é¿é›£ï¼';
                    } else if (highestGrade === 'Warning') {
                        tsunamiWarningEl.textContent = 'ã€æ´¥æ³¢è­¦å ±ã€‘';
                        tsunamiWarningEl.className = 'tsunami-warning';
                        notificationTitle = 'ã€æ´¥æ³¢è­¦å ±ã€‘';
                        notificationBody = 'æ´¥æ³¢è­¦å ±ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸã€‚é¿é›£ã—ã¦ãã ã•ã„ã€‚';
                    } else if (highestGrade === 'Advisory') {
                        tsunamiWarningEl.textContent = 'ã€æ´¥æ³¢æ³¨æ„å ±ã€‘';
                        tsunamiWarningEl.className = 'tsunami-advisory';
                        notificationTitle = 'ã€æ´¥æ³¢æ³¨æ„å ±ã€‘';
                        notificationBody = 'æ´¥æ³¢æ³¨æ„å ±ãŒç™ºè¡¨ã•ã‚Œã¾ã—ãŸã€‚æµ·å²¸ã«è¿‘ã¥ã‹ãªã„ã§ãã ã•ã„ã€‚';
                    }
                }

                if (lastNotifiedInfo.tsunamiGrade !== highestGrade) {
                    sendNotification(notificationTitle, notificationBody);
                    lastNotifiedInfo.tsunamiGrade = highestGrade;
                }
                
                return true;
            }
            
            // [556] ç·Šæ€¥åœ°éœ‡é€Ÿå ±ï¼ˆè­¦å ±ï¼‰ (å¤‰æ›´ãªã—)
            function handleEEW(data) {
                console.log('EEW(è­¦å ±)å‡¦ç†:', data);

                if (!data.report_id || !data.time) {
                    console.warn('[556] å¿…é ˆãƒ‡ãƒ¼ã‚¿(id or time)ãŒæ¬ è½ã€‚ã‚¹ã‚­ãƒƒãƒ—:', data);
                    return false;
                }

                const maxScaleEEW = data.maxScale || 0;
                const magnitude = data.earthquake?.magnitude || 0;
                const hypoName = data.earthquake?.hypocenter?.name || "";
                const hypoLat = data.earthquake?.hypocenter?.latitude || 0;
                const tsunamiInfo = data.earthquake?.tsunami || "None";

                if (maxScaleEEW <= 0 && magnitude <= 0 && hypoName === "" && hypoLat === 0 && tsunamiInfo === "None") {
                     console.warn('[556] æ™‚é–“ä»¥å¤–ã®ä¸»è¦æƒ…å ±ãŒã™ã¹ã¦ä¸æ˜ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—:', data);
                     return false;
                }

                earthquakeInfoPanel.style.display = 'block';
                recentInfoPanel.style.display = 'none';
                intensityDetailsEl.innerHTML = `<li>ç·Šæ€¥åœ°éœ‡é€Ÿå ±(è­¦å ±) ç¬¬${data.report_num || 'ï¼Ÿ'}å ± å—ä¿¡ä¸­...</li>`;
                
                const tsunamiInfoDisplay = data.earthquake?.tsunami;
                
                maxIntensityEl.textContent = maxScaleEEW > 0 ? `æœ€å¤§éœ‡åº¦ ${convertScale(maxScaleEEW)} (äºˆæ¸¬)` : 'æœ€å¤§éœ‡åº¦ ä¸æ˜ (äºˆæ¸¬)';
                magnitudeEl.textContent = data.earthquake?.magnitude || '---';
                hypocenterEl.textContent = data.earthquake?.hypocenter?.name || '---';
                earthquakeTimeEl.textContent = new Date(data.time).toLocaleString('ja-JP');

                if (tsunamiInfoDisplay === 'Warning') {
                     tsunamiWarningEl.textContent = 'ã€æ´¥æ³¢è­¦å ±ã€‘(EEW)';
                     tsunamiWarningEl.className = 'tsunami-warning';
                } else if (tsunamiInfoDisplay === 'Advisory') {
                     tsunamiWarningEl.textContent = 'ã€æ´¥æ³¢æ³¨æ„å ±ã€‘(EEW)';
                     tsunamiWarningEl.className = 'tsunami-advisory';
                } else {
                     tsunamiWarningEl.textContent = 'æ´¥æ³¢æƒ…å ± ç¢ºèªä¸­...';
                     tsunamiWarningEl.className = '';
                }

                earthquakeLayer.clearLayers();
                if (data.earthquake?.hypocenter && data.earthquake.hypocenter.latitude) {
                    const lat = data.earthquake.hypocenter.latitude;
                    const lon = data.earthquake.hypocenter.longitude;
                    
                    L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'hypocenter-icon',
                            html: 'ğŸš¨',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    }).addTo(earthquakeLayer)
                        .bindPopup(`[ç·Šæ€¥åœ°éœ‡é€Ÿå ±]<br>éœ‡æºåœ°(äºˆæ¸¬): ${data.earthquake.hypocenter.name}`)
                        .openPopup();
                    
                    map.setView([lat, lon], 7);
                }

                // é«˜åº¦ãªé€šçŸ¥ãƒ­ã‚¸ãƒƒã‚¯
                lastNotifiedInfo.isEEWActive = true;
                
                if (lastNotifiedInfo.eewId !== data.report_id) {
                    console.log('æ–°è¦EEWç™ºä»¤');
                    sendNotification(
                        `ã€ç·Šæ€¥åœ°éœ‡é€Ÿå ±ï¼ˆè­¦å ±ï¼‰ã€‘`,
                        `${data.earthquake?.hypocenter?.name || 'ä¸æ˜'}ã§åœ°éœ‡ã€‚æœ€å¤§éœ‡åº¦${convertScale(maxScaleEEW)} (äºˆæ¸¬)ã€‚${tsunamiInfo !== 'None' ? 'æ´¥æ³¢ã®å¯èƒ½æ€§ã‚ã‚Šã€‚' : ''}`
                    );
                    lastNotifiedInfo.eewId = data.report_id;
                    lastNotifiedInfo.maxScale = maxScaleEEW;
                    lastNotifiedInfo.tsunamiGrade = tsunamiInfo || 'Safe';
                
                } else {
                    let updateMessage = '';
                    
                    if (lastNotifiedInfo.maxScale < maxScaleEEW) {
                        console.log('EEWæ›´æ–°ï¼ˆéœ‡åº¦ï¼‰');
                        updateMessage = `æœ€å¤§éœ‡åº¦ãŒ${convertScale(maxScaleEEW)}ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚`;
                        lastNotifiedInfo.maxScale = maxScaleEEW;
                    }
                    
                    const newTsunamiGrade = tsunamiInfo || 'Safe';
                    if (lastNotifiedInfo.tsunamiGrade === 'Safe' && (newTsunamiGrade === 'Advisory' || newTsunamiGrade === 'Warning')) {
                        console.log('EEWæ›´æ–°ï¼ˆæ´¥æ³¢ï¼‰');
                        updateMessage += ` ${newTsunamiGrade === 'Warning' ? 'æ´¥æ³¢è­¦å ±' : 'æ´¥æ³¢æ³¨æ„å ±'}ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚`;
                        lastNotifiedInfo.tsunamiGrade = newTsunamiGrade;
                    }

                    if (updateMessage) {
                        sendNotification(
                            `ã€EEWæ›´æ–°ã€‘ç¬¬${data.report_num}å ±`,
                            updateMessage
                        );
                    }
                }
                
                return true;
            }


            // --- 7. ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (éœ‡åº¦å¤‰æ›) (å¤‰æ›´ãªã—) ---
            const scaleMap = {
                10: '1', 20: '2', 30: '3', 40: '4', 
                45: '5å¼±', 50: '5å¼·', 55: '6å¼±', 60: '6å¼·', 70: '7'
            };
            function convertScale(scale) {
                if (!scale || scale <= 0) return '---';
                return scaleMap[scale] || 'ä¸æ˜';
            }
            
            function getIntensityClass(scale) {
                const classMap = {
                    10: 'intensity-1', 20: 'intensity-2', 30: 'intensity-3', 40: 'intensity-4',
                    45: 'intensity-5-weak', 50: 'intensity-5-strong',
                    55: 'intensity-6-weak', 60: 'intensity-6-strong',
                    70: 'intensity-7'
                };
                return classMap[scale] || '';
            }
            
            function convertScaleText(scale) {
                if (!scale || scale <= 0) return '---';
                 const textMap = {
                    10: 'éœ‡åº¦1', 20: 'éœ‡åº¦2', 30: 'éœ‡åº¦3', 40: 'éœ‡åº¦4',
                    45: 'éœ‡åº¦5å¼±', 50: 'éœ‡åº¦5å¼·', 55: 'éœ‡åº¦6å¼±', 60: '6å¼·', 70: 'éœ‡åº¦7'
                };
                return textMap[scale] || 'ä¸æ˜';
            }

            // --- 8. é€šçŸ¥é–¢æ•° (å¤‰æ›´ãªã—) ---
            function sendNotification(title, body) {
                console.log(`é€šçŸ¥å®Ÿè¡Œ: ${title} - ${body}`);
                
                if (Notification.permission === 'granted') {
                    const options = {
                        body: body,
                        icon: 'https://cdn-icons-png.flaticon.com/128/1042/1042813.png',
                        tag: 'earthquake-info'
                    };
                    new Notification(title, options);
                }
                
                alertSound.play().catch(e => {
                    console.warn('éŸ³å£°å†ç”ŸãŒãƒ–ãƒ©ã‚¦ã‚¶ã«ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚');
                });
            }

            function requestNotificationPermission() {
                if ('Notification' in window) {
                     Notification.requestPermission().then(permission => {
                        if (permission === 'granted') console.log('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸ');
                        else console.warn('é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
                    });
                }
            }
            
            document.body.addEventListener('click', () => {
                alertSound.play().catch(() => {});
                alertSound.pause();
                alertSound.currentTime = 0;
                requestNotificationPermission();
            }, { once: true });


            // â˜… æ–°è¦: ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®æƒ…å ±ãƒã‚§ãƒƒã‚¯ (Feature 4, 5)
            async function checkRecentActivityOnLoad() {
                const now = new Date();
                const TEN_MINUTES = 10 * 60 * 1000;
                const NINETY_MINUTES = 90 * 60 * 1000;

                try {
                    // å„ªå…ˆåº¦1: 10åˆ†ä»¥å†…ã®åœ°éœ‡(551)
                    console.log('èµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯1: 10åˆ†ä»¥å†…ã®åœ°éœ‡(551)');
                    const quakeRes = await fetch('https://api.p2pquake.net/v2/history?codes=551&limit=1');
                    const quakeData = await quakeRes.json();
                    
                    if (quakeData && quakeData.length > 0) {
                        const latestQuake = quakeData[0];
                        const quakeTime = new Date(latestQuake.time);
                        if (now - quakeTime < TEN_MINUTES) {
                            console.log('10åˆ†ä»¥å†…ã®åœ°éœ‡ã‚’ç™ºè¦‹ã€‚è©³ç´°è¡¨ç¤ºã—ã¾ã™ã€‚');
                            handleEarthquakeInfo(latestQuake);
                            return true; // è©³ç´°è¡¨ç¤ºã—ãŸã®ã§true
                        }
                    }

                    // å„ªå…ˆåº¦2: 1.5æ™‚é–“(90åˆ†)ä»¥å†…ã®EEW(556)
                    console.log('èµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯2: 90åˆ†ä»¥å†…ã®EEW(556)');
                    const eewRes = await fetch('https://api.p2pquake.net/v2/history?codes=556&limit=1');
                    const eewData = await eewRes.json();

                    if (eewData && eewData.length > 0) {
                        const latestEEW = eewData[0];
                        const eewTime = new Date(latestEEW.time);
                        if (now - eewTime < NINETY_MINUTES) {
                            console.log('90åˆ†ä»¥å†…ã®EEWã‚’ç™ºè¦‹ã€‚è©³ç´°è¡¨ç¤ºã—ã¾ã™ã€‚');
                            handleEEW(latestEEW);
                            return true; // è©³ç´°è¡¨ç¤ºã—ãŸã®ã§true
                        }
                    }
                    
                } catch (err) {
                    console.error('èµ·å‹•æ™‚ã®å±¥æ­´ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—:', err);
                }
                
                console.log('èµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯: è©³ç´°è¡¨ç¤ºã™ã‚‹æƒ…å ±ãªã—ã€‚');
                return false; // è©³ç´°è¡¨ç¤ºã—ãªã‹ã£ãŸã®ã§false
            }


            // --- 9. åˆæœŸæ¥ç¶šé–‹å§‹ ---
            
            // â˜… å¤‰æ›´: èµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã€è©³ç´°è¡¨ç¤ºã—ãªã‹ã£ãŸå ´åˆã®ã¿å±¥æ­´ä¸€è¦§ã‚’è¡¨ç¤º
            const didShowDetails = await checkRecentActivityOnLoad();
            if (!didShowDetails) {
                fetchRecentEarthquakes(); // é€šå¸¸ã®å±¥æ­´ä¸€è¦§ã‚’è¡¨ç¤º
            }
            
            connectWebSocket(); // WebSocketæ¥ç¶šé–‹å§‹

        });
    </script>

</body>
</html>
